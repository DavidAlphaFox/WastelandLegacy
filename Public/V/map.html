<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=0.5, maximum-scale=0.5, minimum-scale=1.0">
    <meta name="description" content="废土战记">
    <meta name="author" content="路漫漫">
    <title>Title</title>
    <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
</head>
<scrtipt>

</scrtipt>
<style>
    @keyframes aniMove{
        100%{background-position-x:72px;}
    }

    @keyframes aniFrame{
        100%{background-position-x:72px;}
    }

    #sprite {
        width: 24px;
        height: 24px;
        background-image: url("http://game.duanxq.cn/images/charasets/NPC (6).png");
        animation: aniMove steps(3,end) 0.3s infinite;
        animation-play-state:paused;
    }

</style>
<body>
<!--<div id="sprite"></div>-->
<!--<button id="restart" onclick="reset();">重新开始</button>-->
</body>
<script src="./Static/js/resources.js"></script>
<script src="./Static/js/sprite.js"></script>
<script src="./Static/js/input.js"></script>
<script src="./Static/js/gameLib.js"></script>
<script src="./Static/js//mapTest.js"></script>
<script>
    var mapWidth,mapHeight,tileSize=24,img,mapSize = {x:0,y:0};

    var id = userInfo.id;

    //扩展send方法
    WebSocket.prototype.wlSend = function (params) {
        var data = {
            id:this.name,
            service:this.service,
            data:params
        };
        data = JSON.stringify(data);
        this.send(data);
    };

//    var WS = new WebSocket("ws://127.0.0.1:2416");
    //握手成功触发
//    WS.onopen = function(){
//        console.log("握手成功");
//        if(ws.readyState==1){
//            ws.send(JSON.stringify({id:id,wl:userInfo.wl}));
//        }
//    };
//    //服务器发送消息，触发
//    WS.onmessage = function(e){
//        //e.data就是服务器发送的信息
//        console.log( JSON.parse(e.data) );
//        //接下来爱干嘛干嘛去、
//        //...code...
//    };
//    //出错时触发方法
//    WS.onerror = function(e){
//        console.log( e );
//    };

    //地图
    var urlArr = ["http://game.duanxq.cn/cache/map_3_0.png","http://game.duanxq.cn/cache/map_3_1.png","http://game.duanxq.cn/cache/map_3_2.png","http://game.duanxq.cn/images/charasets/NPC (6).png"];

    //    foreach ( data['mapImg'] as v){
    //        urlArr.push(v);
    //    }
    //
    //    //地图碰撞标识
    //    var downPass = data.downMapPass;
    //    for(){
    //        mapPass[v.x][v.y] =  v.pass;
    //    }
    //
    //    foreach ( data['upMapPass'] as v){ if(!v['pass']) mapPass[v['x']][v['y']] = v['pass'];}


    var mapPass = [
        [true,true,true,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,false,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,false,true,true,true,true,false,false,false,true,true],
        [true,true,true,false,true,true,true,true,true,false,false,false,false,true,true,true,true,true,false,true,false,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,true,false,false,false,false,true,false,false,true,true,true,true,true,true,true,true,false,false,false,false,true,true],
        [true,true,true,false,true,true,true,true,false,false,true,false,false,false,true,true,true,true,true,true,true,true,true,true,false,true,false,false,true,true],
        [true,true,true,false,false,false,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,false,true,false,true,true,true,true,true,true,false,false,false,false,true,true,true,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,false,false,true,true,true,false,false,false,false,true,true,true,false,false,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,false,true,true,true,false,false,false,false,false,true,true,true,true,false,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,false,false,false,false,false,true,true,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,false,false,true,true,true,true,true,true,false,false,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,false,false,true,true,true,true,true,false,false,true,false,false,true,true,true,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,false,true,true,true,true,true,true,true,true,true,true,false,true,true,true,true,true,true,true,true,true,true,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,true,false,true,true],
        [true,true,true,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,true,true,false,false,true,true],
        [true,true,true,false,false,false,false,false,false,false,false,false,true,true,true,true,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
        [true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true],
        [true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true]
    ];

    //加载资源
    resources.load(urlArr);
    resources.onReady(init);

    function init() {
        img = resources.get();
        mapHeight = img[urlArr[0]].height;
        mapWidth = img[urlArr[0]].width;
        mapSize.x = mapWidth/tileSize;
        mapSize.y = mapHeight/tileSize;
        lastTime = Date.now();
        createCanavs();
        main();
    }

    // 页面重绘前，通知浏览器调用一个指定的函数
    // 具体看https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame
    var requestAnimFrame = (function(){
        return window.requestAnimationFrame       ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            window.oRequestAnimationFrame      ||
            window.msRequestAnimationFrame     ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);//一秒60帧
            };
    })();
    var canvas,canvas2,ctx,ctx2,terrainPattern,terrainPattern1,terrainPattern2;
    function createCanavs() {
        // Create the canvas
        canvas = document.createElement("canvas");
        canvas2 = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        ctx2 = canvas2.getContext("2d");
        canvas2.width = canvas.width = mapWidth;
        canvas2.height = canvas.height = mapHeight;
        document.body.appendChild(canvas);
        document.body.appendChild(canvas2);
        $(canvas).css({
            "position": "absolute",
            "z-index": 1
        });
        $(canvas2).css({
            "position": "absolute",
            "z-index": 1
        });


        terrainPattern  = ctx.createPattern(img[urlArr[0]],'no-repeat');
        terrainPattern1  = ctx.createPattern(img[urlArr[1]],'no-repeat');
        terrainPattern2  = ctx.createPattern(img[urlArr[2]],'no-repeat');


        ctx2.fillStyle = terrainPattern1;
        ctx2.fillRect(0, 0, mapWidth, mapHeight);
        getMousePos(canvas2,getCanavsClickPoint);


    }

    // The main game loop
    var lastTime,moveState;
    function main() {
        var now = Date.now();
        var dt = (now - lastTime) / 1000.0;

        update(dt);
        render();

        lastTime = now;
        requestAnimFrame(main);
    }

    // Game state
    var player = {
        pos: [0, 0],
        p: {x:12,y:12},
        sprite: new Sprite(urlArr[3], [0, 0], [tileSize,tileSize], 10, [0, 1, 2, 3])
    };

    var gameTime = 0;
    var playerSpeed = 100;

    function update(dt) {
        gameTime += dt;
        handleInput(dt);
        player.sprite.update(dt);
    }


    function handleInput(dt) {
        if (input.isDown('DOWN') || input.isDown('s')) {
//                    if (moveState=true) return;
            player.sprite.running = true;
            var isMove = checkCollisions(player.pos[0]*tileSize, player.pos[1]*tileSize + playerSpeed * dt);
            if (isMove) {
                player.p.y += playerSpeed * dt;
                $("#sprite").css({
                    "background-position-y": "0px",
                    "animation-play-state": "running"
                });
            }


        }

        if (input.isDown('UP') || input.isDown('w')) {
//                    if (moveState=true) return;

            player.sprite.running = true;
            player.sprite.pos = [0, 3 * tileSize];
            var isMove = checkCollisions(player.pos[0]*tileSize, player.pos[1]*tileSize - playerSpeed * dt);
            if (isMove) {
                player.p.y -= playerSpeed * dt;
                $("#sprite").css({
                    "background-position-y": "24px",
                    "animation-play-state": "running"
                });
            }
        }

        if (input.isDown('LEFT') || input.isDown('a')) {
//                    if (moveState=true) return;

            player.sprite.running = true;
            player.sprite.pos = [0, 1 * tileSize];
            var isMove = checkCollisions(player.pos[0]*tileSize - playerSpeed * dt, player.pos[1]*tileSize);
            if (isMove) {
                player.p.x -= playerSpeed * dt;
                $("#sprite").css({
                    "background-position-y": "72px",
                    "animation-play-state": "running"
                });
            }
        }

        if (input.isDown('RIGHT') || input.isDown('d')) {
//                    if (moveState=true) return;

            player.sprite.running = true;
            var isMove = checkCollisions(player.pos[0]*tileSize + playerSpeed * dt, player.pos[0]*tileSize);
            if (isMove) {
                player.p.x += playerSpeed * dt;
                $("#sprite").css({
                    "background-position-y": "48px",
                    "animation-play-state": "running"
                });
            }
        }

    }

    // Draw everything
    function render() {
        ctx.fillStyle = terrainPattern;
        ctx.fillRect(0, 0, mapWidth, mapHeight);
        ctx.fillStyle = terrainPattern2;
        ctx.fillRect(0, 0, mapWidth, mapHeight);
        renderEntity(player);
//        renderEntities(eventData);

    }

    function renderEntities(list) {
//        var len = list.length;
//        for(var i=0; i<len; i++) {
//            renderEntity(list[i]);
//        }
        for (var k in list) {
            renderEntity(list[k]);
        }

    }

    function renderEntity(entity) {
        ctx.save();
        ctx.translate(entity.p.x, entity.p.y);
        entity.sprite.render(ctx);
        ctx.restore();
    }

</script>
<script src="./Static/js/collision.js"></script>
</html>
