<!--
/**
 *         ▂▃╬▄▄▃▂▁▁
 *  ●●●█〓██████████████▇▇▇▅▅▅▅▅▅▅▅▅▇▅▅          BUG
 *  ▄▅████☆RED █ WOLF☆███▄▄▃▂
 *  █████████████████████████████
 *  ◥⊙▲⊙▲⊙▲⊙▲⊙▲⊙▲⊙▲⊙▲⊙◤
 *
 * 后台地图编辑
 * @author 路漫漫
 * @link ahmerry@qq.com
 * @version
 * v2017/04/13 初版
 */
-->
<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="废土战记">
    <meta name="author" content="路漫漫">
    <title>废土战记</title>
    <link rel="shortcut icon" href="./../favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./Static/css/style.css" type="text/css" />
    <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>
    
</body>
<script src="./Static/js/resources.js"></script>
<script src="./Static/js/sprite.js"></script>
<script src="./Static/js/input.js"></script>

<script>
    var tileSet={},imgObj,mapHeight,mapWidth,mapSize={x:0,y:0},tileSize=0,map=[],tileCanvas;
    $.post('http://e.cn/Public/index', {}, function (result) {
//        console.log(result);
        mapDataProcess(result);
    });

    //load resources
//    var urlArr = ["./Static/img/瓦片.png"];
//    resources.load(urlArr[0]);
//    resources.onReady(init);

    function init() {
        imgObj = resources.get(urlArr[0]);
        mapHeight = imgObj.height;
        mapWidth = imgObj.width;
        mapSize.x = mapWidth/tileSize;
        mapSize.y = mapHeight/tileSize;
        createCanavs();
    }

    function createCanavs() {
        // Create the canvas
        canvas = document.createElement("canvas");
        canvas2 = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        ctx2 = canvas2.getContext("2d");
        canvas.width = mapWidth;
        canvas.height = mapHeight;
        document.body.appendChild(canvas);

        terrainPattern  = ctx.createPattern(imgObj,'no-repeat');
        ctx.fillStyle = terrainPattern;
        ctx.fillRect(0, 0, mapWidth, mapHeight);
        getMousePos(canvas,getCanavsClickPoint);
    }
    function getCanavsClickPoint(point) {
        console.log(point);
    }
    /**
     * Tile map data process
     */
    function mapDataProcess(data) {
        //get tile set data ```source: "map.png", width: "256", height: "877"```
        var tmp = data['tileset']['@attributes'];
        tileSet = data['tileset']['image']['@attributes'];
        tileSet.columns = tmp['columns'];
        tileSet.tileHeight = tmp['height'];
        tileSet.tileWidth = tmp['width'];

        //get tile map data ```name: "meta", width: "255", height: "255", opacity: "0.49",data:"1,1,1,1,1,1..."```
        for (var i = 0; i < data['layer'].length; i++) {
            map.push(data['layer'][i]['@attributes']);
            map[i].data = data['layer'][i]['data']
        }

        //data process,start render



        console.log();
//        var data = map.data,arr = [];
//        //down map layer
//        for ( var y = 0; y < map.countY; y++ ) {
//            for ( var x = 0; x < map.countX; x++ ) {
//                arr.push({
//                    'id' : 'd_' + x + '_' + y,
//                    'x' : x,
//                    'y' : y,
//                    'img' : data[0][y][x],
//                    'pass' : tileSet[0][1][data[1][y][x]]
//                })
//            }
//        }
    }

    /**
     * Render tile map
     */
    function drawMap() {

    }
    /**
     * Create a canvas to ram
     */
    function createCanavsRam(imgObj,tileSet) {
        var tileCanvas = document.createElement("canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = tileSet.width;
        canvas.height = tileSet.height;

        terrainPattern  = ctx.createPattern(imgObj,'no-repeat');
        ctx.fillStyle = terrainPattern;
        ctx.fillRect(0, 0, tileSet.width, tileSet.height);

        //ctx.drawImage(imgObj,x,y,w,h,ix,iy,iw,ih)
    }
</script>
</html>