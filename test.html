<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="废土战记">
    <meta name="author" content="路漫漫">
    <title>Title</title>
    <script src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
</head>
<style>
    @keyframes aniMove{
        100%{background-position-x:72px;}
    }

    @keyframes aniFrame{
        100%{background-position-x:72px;}
    }

    #sprite {
        width: 24px;
        height: 24px;
        background-image: url("images/charasets/NPC (6).png");
        animation: aniMove steps(3,end) 0.3s infinite;
        animation-play-state:paused;
    }
</style>
<body>
<div id="sprite"></div>
<!--<button id="restart" onclick="reset();">重新开始</button>-->
</body>
<script src="javascript/resources.js"></script>
<script src="javascript/sprite.js"></script>
<script src="javascript/input.js"></script>

<script>
    var urlArr = ["cache/map_4_0.png","cache/map_4_1.png","cache/map_4_2.png","images/charasets/NPC (6).png"];
    var mapWidth,mapHeight,tileSize=[24,24],img;

    //加载资源
    resources.load(urlArr);
    resources.onReady(init);

    function init() {
        img = resources.get();
        mapHeight = img[urlArr[0]].height;
        mapWidth = img[urlArr[0]].width;
        lastTime = Date.now();
        createCanavs();
        main();
    }

    // 页面重绘前，通知浏览器调用一个指定的函数
    // 具体看https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame
    var requestAnimFrame = (function(){
        return window.requestAnimationFrame       ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            window.oRequestAnimationFrame      ||
            window.msRequestAnimationFrame     ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);//一秒60帧
            };
    })();
    var canvas,ctx,terrainPattern;
    function createCanavs() {
        // Create the canvas
        canvas = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        canvas.width = mapWidth;
        canvas.height = mapHeight;
        document.body.appendChild(canvas);

        terrainPattern  = ctx.createPattern(img[urlArr[0]],'no-repeat');
//        ctx.rect(0,0,mapWidth,mapHeight);
//        ctx.fillStyle=patt;
//        ctx.fill();
    }

    // The main game loop
    var lastTime;
    function main() {
        var now = Date.now();
        var dt = (now - lastTime) / 1000.0;

        update(dt);
        render();

        lastTime = now;
        requestAnimFrame(main);
    }

    // Game state
    var player = {
        pos: [0, 0],
        sprite: new Sprite(urlArr[3], [0, 0], tileSize, 10, [0, 1, 2, 3])
    };

    var gameTime = 0;
    var playerSpeed = 100;

    function update(dt) {
        gameTime += dt;

        handleInput(dt);
        player.sprite.update(dt);

    }


    function handleInput(dt) {
        if(input.isDown('DOWN') || input.isDown('s')) {
            player.sprite.running=true;
            player.sprite.pos=[0,0];
            player.pos[1] += playerSpeed * dt;
            $("#sprite").css({
                "background-position-y" : "0px",
                "animation-play-state" : "running"
            });
        }

        if(input.isDown('UP') || input.isDown('w')) {
            player.sprite.running=true;
            player.sprite.pos=[0,72];
            player.pos[1] -= playerSpeed * dt;
            $("#sprite").css({
                "background-position-y" : "24px",
                "animation-play-state" : "running"
            });
        }

        if(input.isDown('LEFT') || input.isDown('a')) {
            player.sprite.running=true;
            player.sprite.pos=[0,24];
            player.pos[0] -= playerSpeed * dt;
            $("#sprite").css({
                "background-position-y" : "72px",
                "animation-play-state" : "running"
            });
        }

        if(input.isDown('RIGHT') || input.isDown('d')) {
            player.sprite.running=true;
            player.sprite.pos=[0,48];
            player.pos[0] += playerSpeed * dt;
            $("#sprite").css({
                "background-position-y" : "48px",
                "animation-play-state" : "running"
            });
        }
    }

    // Draw everything
    function render() {
        ctx.fillStyle = terrainPattern;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        renderEntity(player);

    }

    function renderEntities(list) {
        for(var i=0; i<list.length; i++) {
            renderEntity(list[i]);
        }
    }

    function renderEntity(entity) {
        ctx.save();
        ctx.translate(entity.pos[0], entity.pos[1]);
        entity.sprite.render(ctx);
        ctx.restore();
    }

</script>
</html>